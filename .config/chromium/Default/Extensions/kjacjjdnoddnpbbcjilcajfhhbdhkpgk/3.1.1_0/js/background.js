"use strict";var TIME_PER_TREE=10;var treeNum=1;var TOTAL_STAGES=3;var lastTreeTime=1500;var remainingTime=lastTreeTime;var lastSysTime,targetSysTime;var hasCheated;var topDesRandInd=0;var blacklist;var forcedMode=true;var timer;var isLoggedIn=false;var TREE_STATUS={READY:"ready",GROWING:"growing",GROWN:"grown",FAILED:"failed"};var isFinishMessageDismissed=true;var doNotShowFinishMessageForGuest;var purchasedProducts=[];var TREE_TYPE=[{id:0,name:"Cedar",prefix:"tree_default",product_id:-1},{id:1,name:"Flower Tree",prefix:"flower_tree",product_id:1},{id:2,name:"Tree House",prefix:"tree_house",product_id:2},{id:3,name:"Nest",prefix:"bird_tree",product_id:3},{id:4,name:"Lemon Tree",prefix:"lemon_tree",product_id:6},{id:5,name:"Triplets",prefix:"castle_tree",product_id:7},{id:7,name:"Octopus",prefix:"octopus",product_id:10},{id:8,name:"Cherry Blossom",prefix:"cherry_blossom",product_id:11},{id:9,name:"Coconut Tree",prefix:"coconut_tree",product_id:12},{id:10,name:"Cat Tree",prefix:"cat_tree",product_id:13},{id:-1,name:"dummy",prefix:"dummy",product_id:-1}];var currentState=TREE_STATUS.READY;var treeType=0;var currTreeUrl=null;var hasClass=function(el,cls){if(el.nodeName=="#text"){return false}return el.className.match(new RegExp("(\\s|^)"+cls+"(\\s|$)"))?true:false};var addClass=function(el,cls){if(!hasClass(el,cls)){el.className+=" "+cls}};var removeClass=function(el,cls){if(hasClass(el,cls)){var reg=new RegExp("(\\s|^)"+cls+"(\\s|$)");el.className=el.className.replace(reg," ")}};function getDefaultBlacklist(){return["facebook.com","reddit.com","youtube.com"]}function executeToFrontPage(callback,arg){try{var popups=chrome.extension.getViews({type:"popup"});if(0<popups.length){callback(popups[0],arg)}}catch(e){}}function savePlanting(){chrome.storage.local.get({user:null},function(items){var user=items.user;var start_time=(new Date).toISOString();var token=null;if(user!==null){token=user.remember_token}var trees=[];for(var i=0;i<getStageToTreeNumber(getStage(lastTreeTime));++i){trees.push({tree_type:TREE_TYPE[treeType].id,is_dead:true,position:0,phase:8})}chrome.storage.local.set({planting:{plant:{start_time:start_time,end_time:start_time,is_success:false,tag:0,note:chrome.i18n.getMessage("main_planting_note"),trees:trees},authenticate_token:token}},function(){})})}function uploadTree(){chrome.storage.local.get({planting:null},function(items){var p=items.planting;if(p!==null){if(p.authenticate_token!==null){var xhr=new XMLHttpRequest;xhr.open("POST","https://c88fef96.forestapp.cc/api/v1/plants",true);var string=JSON.stringify(p);xhr.setRequestHeader("Content-type","application/json; charset=utf-8");xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status==200){}else{chrome.storage.local.remove("user",function(){})}}};xhr.send(string)}chrome.storage.local.remove("planting",function(){})}})}function getStageToTreeNumber(stage){var number=stage-3;return number>=0?number:0}function getStage(time){if(time<600){return 1}else if(time<1200){return 2}else if(time<1500){return 3}else if(time<3600){return 4}else if(time<5400){return 5}else if(time<7200){return 6}else{return 7}}function getCurrTreeStage(){var passedTime=lastTreeTime-remainingTime;return getStage(passedTime)}function resetTree(){currentState=TREE_STATUS.READY;remainingTime=lastTreeTime}function getTimerText(){if(remainingTime<0){return""}var minute=Math.floor(remainingTime/60);var second=Math.floor(remainingTime%60);return(minute>=10?"":"0")+minute+":"+(second>=10?"":"0")+second}function setTimerText(){var timerText=getTimerText();if(currentState==TREE_STATUS.READY||currentState==TREE_STATUS.GROWING){hide("share-icons")}else{timerText="";unhide("share-icons")}executeToFrontPage(function(fp){fp.document.getElementById("timer").textContent=timerText})}function hide(id){executeToFrontPage(function(fp){addClass(fp.document.getElementById(id),"hidden")})}function unhide(id){executeToFrontPage(function(fp){removeClass(fp.document.getElementById(id),"hidden")})}function isTreeTypePurchased(treeType){if(TREE_TYPE[treeType].product_id==-1){return true}for(var idx in purchasedProducts){if(TREE_TYPE[treeType].product_id==purchasedProducts[idx].product_id){return true}}return false}function computeSuccessfulReward(totalSeconds){var totalMin=Math.floor(totalSeconds/60);var baseCoin=4;var fiveMinCoin=1;var thirtyMinCoin=5;return baseCoin+Math.floor(totalMin/5)*fiveMinCoin+Math.max(Math.floor(totalMin/30)-1,0)*thirtyMinCoin}function onClickFinishConfirmedButton(doNotShowFinishMessageForGuest){isFinishMessageDismissed=true;executeToFrontPage(function(fp){var finishPopup=fp.document.getElementById("finish-popup");addClass(finishPopup,"finish-popup-shrink");var finishMask=fp.document.getElementById("finish-mask");removeClass(finishMask,"finish-masked")});window.setTimeout(function(){hide("finish-popup");hide("finish-mask")},300);if(doNotShowFinishMessageForGuest){doNotShowFinishMessageForGuest=true;chrome.storage.local.set({doNotShowFinishMessageForGuest:true},function(){})}}function updateUI(){var img;var seed_img;var topDesc;var stage=getCurrTreeStage();hide("timer-left-arrow");hide("timer-right-arrow");hide("treeball-left-arrow");hide("treeball-right-arrow");switch(currentState){case TREE_STATUS.READY:var readyStage=getStage(lastTreeTime);if(readyStage<3){img="./images/trees/tree1/"+"tree_default_"+readyStage+".png"}else{img="./images/trees/tree"+(TREE_TYPE[treeType].id+1)+"/"+TREE_TYPE[treeType].prefix+"_"+readyStage+".png"}if(isTreeTypePurchased(treeType)){hide("locker");executeToFrontPage(function(fp){removeClass(fp.document.getElementById("tree"),"shadowed-tree")});topDesc=chrome.i18n.getMessage("main_top_description_ready")}else{unhide("locker");executeToFrontPage(function(fp){addClass(fp.document.getElementById("tree"),"shadowed-tree")});topDesc=chrome.i18n.getMessage("main_top_description_locked")}unhide("tree");unhide("seed");unhide("timer-left-arrow");unhide("timer-right-arrow");unhide("treeball-left-arrow");unhide("treeball-right-arrow");break;case TREE_STATUS.GROWING:if(stage<3){img="./images/trees/tree1/"+"tree_default_"+stage+".png"}else{img="./images/trees/tree"+(TREE_TYPE[treeType].id+1)+"/"+TREE_TYPE[treeType].prefix+"_"+stage+".png"}hide("seed");unhide("tree");hide("plant-board");hide("plant-board-text");if(remainingTime%10===0){topDesRandInd=Math.floor(Math.random()*13)}topDesc=chrome.i18n.getMessage("main_message_growing_text_"+topDesRandInd);executeToFrontPage(function(fp){addClass(fp.document.getElementById("finish-popup"),"finish-popup-shrink")});break;case TREE_STATUS.GROWN:img="./images/trees/tree"+(TREE_TYPE[treeType].id+1)+"/"+TREE_TYPE[treeType].prefix+"_"+stage+".png";hide("seed");unhide("tree");hide("plant-board");hide("plant-board-text");topDesc=chrome.i18n.getMessage("main_top_description_grown");if(isFinishMessageDismissed){hide("finish-popup");hide("finish-mask")}else{unhide("finish-popup");unhide("finish-mask");executeToFrontPage(function(fp){addClass(fp.document.getElementById("finish-mask"),"finish-masked")});if(isLoggedIn){hide("do-not-show-finish-message-container");hide("finish-message-for-guest-container");executeToFrontPage(function(fp){fp.document.getElementById("coins-for-user").textContent=computeSuccessfulReward(lastTreeTime);addClass(fp.document.getElementById("finish-popup"),"finish-popup-for-user-width")})}else{hide("finish-message-for-user-container");executeToFrontPage(function(fp){removeClass(fp.document.getElementById("finish-popup"),"finish-popup-for-user-width")});if(doNotShowFinishMessageForGuest){hide("finish-popup");hide("finish-mask")}}}break;case TREE_STATUS.FAILED:img="./images/trees/tree"+(TREE_TYPE[treeType].id+1)+"/"+TREE_TYPE[treeType].prefix+"_dead.png";hide("seed");unhide("tree");hide("plant-board");hide("plant-board-text");topDesc=chrome.i18n.getMessage("main_top_description_failed");break}currTreeUrl=img;executeToFrontPage(function(fp){fp.document.getElementById("tree").style.backgroundImage="url('"+img+"')"});executeToFrontPage(function(fp){fp.document.getElementById("top-description").textContent=topDesc;removeClass(fp.document.getElementById("top-description"),"highlight-top-description")});if(currentState===TREE_STATUS.READY){unhide("setting-icon");unhide("top-icons");chrome.tabs.query({active:true,lastFocusedWindow:true},function(tabs){if(tabs.length>0){var tab=tabs[0];if(typeof tab.url=="undefined"||isBlacklisted(tab)){hide("add-to-blacklist-icon")}else{unhide("add-to-blacklist-icon")}}})}else{hide("add-to-blacklist-icon");hide("setting-icon");hide("top-icons");if(forcedMode&&currentState===TREE_STATUS.GROWING){chrome.tabs.query({},function(tabs){if(tabs.length>0){for(var idx in tabs){var tab=tabs[idx];if(isBlacklisted(tab)){chrome.tabs.sendMessage(tab.id,{type:"overlay",timerText:getTimerText(),treeUrl:img},{},function(){})}}}})}}setTimerText()}function killTree(tab){remainingTime=-1;currentState=TREE_STATUS.FAILED;uploadTree();chrome.tabs.onUpdated.removeListener(checkForBlacklistAccess);chrome.tabs.onReplaced.removeListener(onReplacedHandler);if(tab!==null){window.setTimeout(function(){chrome.tabs.query({url:tab.url},function(tabs){var title=tab.title;if(tabs!==null&&tabs.length>0){title=tabs[0].title}var message=title+" "+chrome.i18n.getMessage("notification_text_on_fail");chrome.notifications.create({type:"basic",iconUrl:"icons/icon-512_padding.png",title:chrome.i18n.getMessage("notification_title_on_fail"),message:message})})},1e3)}clearTimeout(timer);updateUI()}function checkForBlacklistAccess(tabId,changeInfo,tab){if(isBlacklisted(tab)){if(forcedMode){chrome.tabs.sendMessage(tab.id,{type:"overlay",timerText:getTimerText(),treeUrl:currTreeUrl},{},function(){})}else{killTree(tab)}}}function onReplacedHandler(addedTabId,removedTabId){chrome.tabs.get(addedTabId,function(tab){if(tab!==null){checkForBlacklistAccess(tab.id,null,tab)}})}function countDown(){if(hasCheated){remainingTime--}else{var currSysTime=new Date;if(currSysTime.getTime()-lastSysTime.getTime()<6e4&&currSysTime.getTime()-lastSysTime.getTime()>-6e4){remainingTime=(targetSysTime.getTime()-currSysTime.getTime())/1e3;lastSysTime=currSysTime}else{hasCheated=true;remainingTime=(targetSysTime.getTime()-lastSysTime.getTime())/1e3-1;chrome.storage.local.get({user:null},function(items){var user=items.user;ga("send","event","cheatedDetected","cheated",user!==null?"user":"guest")})}remainingTime=Math.floor(remainingTime)}if(remainingTime>0){chrome.storage.local.get({planting:null},function(items){var p=items.planting;p.plant.end_time=(new Date).toISOString();for(var i=0;i<getStageToTreeNumber(getCurrTreeStage())&&i<p.plant.trees.length;++i){p.plant.trees[i].is_dead=false;p.plant.trees[i].phase=i+4}chrome.storage.local.set({planting:p},function(){})});timer=window.setTimeout(countDown,1e3)}else if(currentState==TREE_STATUS.GROWING){if(forcedMode){chrome.tabs.query({},function(tabs){if(tabs.length>0){for(var idx in tabs){var tab=tabs[idx];if(isBlacklisted(tab)){chrome.tabs.sendMessage(tab.id,"unblock",{},function(){})}}}})}chrome.tabs.onUpdated.removeListener(checkForBlacklistAccess);chrome.tabs.onReplaced.removeListener(onReplacedHandler);chrome.storage.local.get({planting:null},function(items){var p=items.planting;p.plant.is_success=true;for(var i=0;i<getStageToTreeNumber(getCurrTreeStage())&&i<p.plant.trees.length;++i){p.plant.trees[i].is_dead=false;p.plant.trees[i].phase=i+4}p.plant.end_time=(new Date).toISOString();chrome.storage.local.set({planting:p},function(){uploadTree()})});currentState=TREE_STATUS.GROWN;chrome.notifications.create({type:"basic",iconUrl:"icons/icon-512_padding.png",title:chrome.i18n.getMessage("notification_title_on_success"),message:chrome.i18n.getMessage("notification_text_on_success")});chrome.storage.local.get({user:null},function(items){var user=items.user;if(user!==null){isLoggedIn=true}else{isLoggedIn=false}isFinishMessageDismissed=false;updateUI();executeToFrontPage(function(fp){removeClass(fp.document.getElementById("finish-popup"),"finish-popup-shrink")})})}updateUI()}function startTimer(){if(currentState!=TREE_STATUS.READY){return}if(!isTreeTypePurchased(treeType)){return}chrome.storage.local.get({forcedMode:true},function(items){forcedMode=items.forcedMode;chrome.storage.local.get({blackList:getDefaultBlacklist()},function(items){blacklist=items.blackList;hasCheated=false;lastSysTime=new Date;targetSysTime=new Date((new Date).getTime()+remainingTime*1e3+200);if(!forcedMode){chrome.tabs.query({},function(tabs){if(tabs.length>0){var highlightTopdescription=function(fp){fp.document.getElementById("top-description").textContent=chrome.i18n.getMessage("main_top_description_black_tab_opened");addClass(fp.document.getElementById("top-description"),"highlight-top-description")};for(var idx in tabs){var tab=tabs[idx];if(isBlacklisted(tab)){var title=tab.title+" "+chrome.i18n.getMessage("notification_title_black_tab_opened");var message=chrome.i18n.getMessage("notification_pre_text_black_tab_opened")+" "+tab.title+" "+chrome.i18n.getMessage("notification_post_text_black_tab_opened");chrome.notifications.create({type:"basic",iconUrl:"icons/icon-512_padding.png",title:title,message:message});executeToFrontPage(highlightTopdescription);return}}currentState=TREE_STATUS.GROWING;savePlanting();updateUI();chrome.tabs.onUpdated.addListener(checkForBlacklistAccess);chrome.tabs.onReplaced.addListener(onReplacedHandler);timer=window.setTimeout(countDown,1e3)}})}else{currentState=TREE_STATUS.GROWING;savePlanting();updateUI();chrome.tabs.onUpdated.addListener(checkForBlacklistAccess);chrome.tabs.onReplaced.addListener(onReplacedHandler);timer=window.setTimeout(countDown,1e3);chrome.tabs.query({},function(tabs){if(tabs.length>0){for(var idx in tabs){var tab=tabs[idx];if(isBlacklisted(tab)){chrome.tabs.sendMessage(tab.id,{type:"overlay",timerText:getTimerText(),treeUrl:currTreeUrl},{},function(){})}}}})}})});chrome.storage.local.get({user:null},function(items){var user=items.user;ga("send","event","startPlanting","startPlanting",user!==null?"user":"guest")})}function adjustTreeType(delta){if(currentState!=TREE_STATUS.READY){return}if(delta<0){treeType+=1;if(treeType>=TREE_TYPE.length-1){treeType=0}}else if(delta>0){treeType-=1;if(treeType<0){treeType=TREE_TYPE.length-2}}else{}chrome.storage.local.set({treeType:treeType},function(){});resetTree();updateUI()}function adjustPlantTime(delta){if(currentState!=TREE_STATUS.READY){return}if(delta<0){lastTreeTime+=300;if(lastTreeTime>7200){lastTreeTime=7200}}else if(delta>0){lastTreeTime-=300;if(lastTreeTime<1500){lastTreeTime=1500}}else{}chrome.storage.local.set({lastTreeTime:lastTreeTime},function(){});resetTree();updateUI()}function onMouseOnTreeball(action){return;if(currentState!=TREE_STATUS.READY||!isTreeTypePurchased(treeType)){return}if(action=="enter"){hide("tree");unhide("plant-board");unhide("plant-board-text")}else{unhide("tree");hide("plant-board");hide("plant-board-text")}}function updatePurchasedProducts(callback){chrome.storage.local.get({user:null},function(items){var user=items.user;if(user===null){purchasedProducts=[];updateUI();return}var xhr=new XMLHttpRequest;xhr.open("GET","https://c88fef96.forestapp.cc/api/v1/purchases",true);var string=JSON.stringify({authenticate_token:user.remember_token});xhr.setRequestHeader("Content-type","application/json; charset=utf-8");xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status==200){var resp=JSON.parse(xhr.responseText);purchasedProducts=resp}else{purchasedProducts=[]}callback();updateUI()}};xhr.send(string)})}function isBlacklisted(tab){if(typeof tab.url=="undefined"){return false}for(var idx in blacklist){if(tab.url.indexOf(blacklist[idx])>=0){return true}}return false}function setBlacklist(blist){blacklist=blist}function clickShareButton(id){var message=currentState===TREE_STATUS.GROWN?chrome.i18n.getMessage("main_share_on_success"):chrome.i18n.getMessage("main_share_on_failed");var url=currentState===TREE_STATUS.GROWN?"http://www.forestapp.cc/sharings/planting_success":"http://www.forestapp.cc/sharings/planting_failed";if(id==="backBtn"){resetTree();updateUI()}else if(id==="twitterBtn"){chrome.tabs.create({url:"https://twitter.com/intent/tweet?text="+message+"&url="+url},function(tab){})}else if(id==="fbBtn"){chrome.tabs.create({url:"https://www.facebook.com/sharer/sharer.php?u="+url},function(tab){})}else{}}function init(){chrome.storage.local.get({lastTreeTime:1500},function(items){lastTreeTime=items.lastTreeTime;chrome.storage.local.get({planting:null},function(items){var p=items.planting;if(p!==null){remainingTime=-1;currentState=TREE_STATUS.FAILED;uploadTree()}else{resetTree()}updateUI()})});chrome.storage.local.get({treeType:0},function(items){treeType=items.treeType;updateUI()});chrome.storage.local.get({blackList:getDefaultBlacklist()},function(items){blacklist=items.blackList});chrome.storage.local.get({forcedMode:true},function(items){forcedMode=items.forcedMode;if(forcedMode){chrome.tabs.query({},function(tabs){if(tabs.length>0){for(var idx in tabs){var tab=tabs[idx];if(!forcedMode&&isBlacklisted(tab)){chrome.tabs.sendMessage(tab.id,{type:"unblock"},{},function(){});return}}}})}});chrome.storage.local.get({doNotShowFinishMessageForGuest:false},function(items){doNotShowFinishMessageForGuest=items.doNotShowFinishMessageForGuest});chrome.tabs.query({},function(tabs){if(tabs.length>0){for(var idx in tabs){var tab=tabs[idx];try{chrome.tabs.executeScript(tab.id,{file:"js/overlay.js"});chrome.tabs.insertCSS(tab.id,{file:"stylesheets/overlay.css"})}catch(e){}}}});updatePurchasedProducts(function(){});function dummy(){}chrome.runtime.onMessage.addListener(function(m,sender,dummy){if(forcedMode&&m.giveUp===true){killTree(null);chrome.notifications.create({type:"basic",iconUrl:"icons/icon-512_padding.png",title:chrome.i18n.getMessage("notification_title_on_giveup"),message:chrome.i18n.getMessage("notification_text_on_giveup")});chrome.tabs.query({},function(tabs){if(tabs.length>0){for(var idx in tabs){var tab=tabs[idx];if(isBlacklisted(tab)){chrome.tabs.sendMessage(tab.id,{type:"failed",timerText:getTimerText(),treeUrl:currTreeUrl},{},function(){})}}}})}})}(function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date;a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,"script","https://www.google-analytics.com/analytics.js","ga");ga("create","UA-76810879-1","auto");ga("set","checkProtocolTask",function(){});ga("send","pageview","/background.html");chrome.storage.local.get({user:null},function(items){var user=items.user;ga("send","event","addon-enabled","enabled",user!==null?"user":"guest")});init();